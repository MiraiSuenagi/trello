<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Management System</title>
  <style>
    /* Стили остались прежними */
  </style>
</head>
<body>
  <div id="auth-container">
    <input type="email" id="email" placeholder="Введите email">
    <input type="password" id="password" placeholder="Введите пароль">
    <button id="login-button">Войти</button>
  </div>

  <div id="project-list">
    <button id="add-project-button">+</button>
  </div>

  <div id="board">
    <div class="column" id="todo">
      <h3>To Do</h3>
      <div class="add-task-container">
        <input type="text" class="task-input" placeholder="Новая задача">
        <button class="add-button">Добавить</button>
      </div>
      <div class="tasks"></div>
    </div>
    <div class="column" id="in-progress">
      <h3>In Progress</h3>
      <div class="add-task-container">
        <input type="text" class="task-input" placeholder="Новая задача">
        <button class="add-button">Добавить</button>
      </div>
      <div class="tasks"></div>
    </div>
    <div class="column" id="done">
      <h3>Done</h3>
      <div class="add-task-container">
        <input type="text" class="task-input" placeholder="Новая задача">
        <button class="add-button">Добавить</button>
      </div>
      <div class="tasks"></div>
    </div>
  </div>
  
  <div id="user-info" style="position: absolute; top: 20px; right: 120px; font-size: 16px; color: #333;"></div>
  <button id="logout-button">Выйти</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase конфигурация
    const firebaseConfig = {
      apiKey: "AIzaSyBA2vfGRmzy2ISbYSCWL4uocBNtXkaG33Y",
      authDomain: "trellokz123.firebaseapp.com",
      projectId: "trellokz123",
      storageBucket: "trellokz123.appspot.com",
      messagingSenderId: "902282094089",
      appId: "1:902282094089:web:20f3874fd2393aa42f3ad8",
      measurementId: "G-7HPT7Q512K"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    const authContainer = document.getElementById('auth-container');
    const projectList = document.getElementById('project-list');
    const board = document.getElementById('board');
    const logoutButton = document.getElementById('logout-button');
    let activeProject = null;

    // Аутентификация пользователя
    auth.onAuthStateChanged(user => {
      if (user) {
        authContainer.style.display = 'none';
        projectList.style.display = 'flex';
        loadProjects();

        document.getElementById('user-info').textContent = `Привет, ${user.email}`;
      } else {
        authContainer.style.display = 'flex';
        projectList.style.display = 'none';
        board.style.display = 'none';

        document.getElementById('user-info').textContent = '';
      }
    });

    // Логин
    document.getElementById('login-button').addEventListener('click', () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          authContainer.style.display = 'none';
          projectList.style.display = 'flex';
          loadProjects();
        })
        .catch(error => {
          console.error('Ошибка авторизации:', error);
          alert('Неверный email или пароль');
        });
    });

    // Выход
    logoutButton.addEventListener('click', () => {
      auth.signOut().catch(error => console.error('Ошибка выхода:', error));
    });

    // Загрузка проектов
    function loadProjects() {
      projectList.innerHTML = '<button id="add-project-button">+</button>';

      document.getElementById('add-project-button').addEventListener('click', addProject);

      firestore.collection('projects').get().then(snapshot => {
        snapshot.forEach(doc => {
          const project = doc.data();
          const projectElement = document.createElement('div');
          projectElement.className = 'project';
          projectElement.setAttribute('data-id', doc.id);

          const projectName = document.createElement('span');
          projectName.textContent = project.name;
          projectName.addEventListener('click', () => openProject(doc.id));

          const deleteButton = document.createElement('button');
          deleteButton.className = 'delete-project';
          deleteButton.textContent = 'Удалить';
          deleteButton.addEventListener('click', () => deleteProject(doc.id));

          projectElement.appendChild(projectName);
          projectElement.appendChild(deleteButton);
          projectList.appendChild(projectElement);
        });
      });
    }

    // Drag-and-Drop
    document.querySelectorAll('.tasks').forEach(taskContainer => {
      taskContainer.addEventListener('dragover', e => {
        e.preventDefault();
        const draggingTask = document.querySelector('.dragging');
        const closestTask = [...taskContainer.querySelectorAll('.task:not(.dragging)')]
          .reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = e.clientY - box.top - box.height / 2;
            return offset < 0 && offset > closest.offset ? { offset, element: child } : closest;
          }, { offset: Number.NEGATIVE_INFINITY }).element;

        closestTask ? taskContainer.insertBefore(draggingTask, closestTask) : taskContainer.appendChild(draggingTask);
      });
    });

    document.addEventListener('dragstart', e => {
      if (e.target.classList.contains('task')) {
        e.target.classList.add('dragging');
      }
    });

    document.addEventListener('dragend', e => {
      if (e.target.classList.contains('task')) {
        e.target.classList.remove('dragging');
        const taskId = e.target.getAttribute('data-id');
        const newColumn = e.target.closest('.column').id;

        firestore.collection('projects').doc(activeProject).collection('tasks').doc(taskId).update({
          column: newColumn
        }).catch(error => console.error('Ошибка обновления колонки:', error));
      }
    });
  </script>
</body>
</html>
