<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBA2vfGRmzy2ISbYSCWL4uocBNtXkaG33Y",
    authDomain: "trellokz123.firebaseapp.com",
    projectId: "trellokz123",
    storageBucket: "trellokz123.appspot.com",
    messagingSenderId: "902282094089",
    appId: "1:902282094089:web:20f3874fd2393aa42f3ad8",
    measurementId: "G-7HPT7Q512K"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const firestore = firebase.firestore();

  let activeProject = null;

  // Check auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      loadProjects();
    }
  });

  // Load projects
  function loadProjects() {
    firestore.collection('projects').get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const projectData = doc.data();
          const projectId = doc.id;
          const projectElement = document.createElement('div');
          projectElement.classList.add('project');
          projectElement.textContent = projectData.name;
          projectElement.addEventListener('click', () => openProject(projectId));
          document.getElementById('project-list').appendChild(projectElement);
        });
      });
  }

  // Open project and load tasks
  function openProject(projectId) {
    activeProject = projectId;

    firestore.collection('projects').doc(projectId).collection('tasks').get()
      .then(snapshot => {
        const tasks = { todo: [], 'in-progress': [], done: [] };
        snapshot.forEach(doc => {
          const task = doc.data();
          tasks[task.status].push({ ...task, id: doc.id });
        });

        document.querySelectorAll('.column').forEach(column => {
          const status = column.id;
          const taskList = column.querySelector('.tasks');
          taskList.innerHTML = '';
          tasks[status].forEach(task => {
            const taskElement = document.createElement('div');
            taskElement.classList.add('task');
            taskElement.setAttribute('draggable', 'true');
            taskElement.setAttribute('data-task-id', task.id);  // Устанавливаем уникальный ID
            taskElement.innerHTML = `
              <span>${task.name}</span>
              <button class="delete-task" onclick="deleteTask('${projectId}', '${task.id}')">X</button>
            `;
            taskElement.addEventListener('dragstart', dragStart);
            taskList.appendChild(taskElement);
          });
        });
      });
  }

  // Dragstart handler
  function dragStart(event) {
    const taskId = event.target.getAttribute('data-task-id');
    event.dataTransfer.setData('taskId', taskId);  // Сохраняем ID задачи
  }

  // Drop handler
  function drop(event) {
    event.preventDefault();
    const taskId = event.dataTransfer.getData('taskId');
    const targetStatus = event.target.closest('.column').id;
    firestore.collection('projects').doc(activeProject).collection('tasks').doc(taskId).update({
      status: targetStatus
    }).then(() => {
      openProject(activeProject);  // Обновляем проект после перемещения задачи
    });
  }

  // Allow drop handler
  function allowDrop(event) {
    event.preventDefault();
  }

  // Initialize drag-and-drop events
  window.onload = () => {
    document.querySelectorAll('.tasks').forEach(taskContainer => {
      taskContainer.addEventListener('dragover', allowDrop);  // Разрешаем перетаскивание
      taskContainer.addEventListener('drop', drop);  // Обрабатываем сброс задачи
    });
  };

  // Delete task
  function deleteTask(projectId, taskId) {
    firestore.collection('projects').doc(projectId).collection('tasks').doc(taskId).delete()
      .then(() => openProject(projectId))
      .catch(error => console.error('Ошибка удаления задачи:', error));
  }

  // Add task
  function addTask(status) {
    const taskName = document.querySelector(`#${status} .task-input`).value.trim();
    if (taskName && activeProject) {
      firestore.collection('projects').doc(activeProject).collection('tasks').add({
        name: taskName,
        status: status
      })
      .then(() => openProject(activeProject))
      .catch(error => console.error('Ошибка добавления задачи:', error));
    }
  }

  // Handle task addition
  document.getElementById('add-todo').addEventListener('click', () => addTask('todo'));
  document.getElementById('add-in-progress').addEventListener('click', () => addTask('in-progress'));
  document.getElementById('add-done').addEventListener('click', () => addTask('done'));
</script>
